name: Issue Submission Automation

on:
  issues:
    types: [opened, closed]

permissions:
  issues: write
  contents: read

jobs:
  handle-submission:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check Issue Labels
        uses: actions/github-script@v7
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const labels = context.payload.issue.labels.map(label => label.name);
            console.log('Issue labels:', labels);
            console.log('Has submission label:', labels.includes('submission'));
            console.log('Action:', context.payload.action);

      - name: Handle New Submission
        if: github.event.action == 'opened' && (contains(github.event.issue.labels.*.name, 'submission') || startsWith(github.event.issue.title, '[SUBMISSION]'))
        uses: actions/github-script@v7
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const issueNumber = context.issue.number;
            
            // Assign the issue to nisalgunawardhana
            await github.rest.issues.addAssignees({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              assignees: ['nisalgunawardhana']
            });
            console.log('Assigned issue to nisalgunawardhana');
            
            // Add welcome comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `## ğŸ‰ Thank you for your submission!
              
              Hello @${context.payload.issue.user.login}! ğŸ‘‹
              
              We've received your submission and it's now under review. Here's what happens next:
              
              ### Review Process
              - âœ… Your submission has been labeled with \`pending review\` and \`submission\`
              - ğŸ‘¤ This issue has been assigned to @nisalgunawardhana for review
              - ğŸ“‹ Your work will be reviewed within 2-3 business days
              - ğŸ’¬ You may receive feedback or questions during the review
              - ğŸ–ï¸ **Once approved and closed by @nisalgunawardhana, your digital badge will be automatically issued in the comments**
              
              ### What You Can Do
              - Keep an eye on this issue for any feedback
              - Respond promptly to any questions from reviewers
              - Make sure your pull request is up to date
              
              ### Badge Issuance
              When @nisalgunawardhana closes this issue as completed:
              - ğŸŠ A congratulations comment with your digital badge will be posted automatically
              - ğŸ·ï¸ Labels will be updated to \`approved\` and \`completed\`
              - ğŸ“§ You'll receive instructions on how to display your badge
              
              Thank you for your patience and for contributing to this project! ğŸš€
              
              ---
              *This is an automated message. @nisalgunawardhana will review your submission soon.*`
            });
            
            console.log('Welcome comment added successfully');

      - name: Handle Approved Submission
        if: github.event.action == 'closed' && github.event.issue.state_reason == 'completed' && (contains(github.event.issue.labels.*.name, 'submission') || startsWith(github.event.issue.title, '[SUBMISSION]'))
        uses: actions/github-script@v7
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const issueNumber = context.issue.number;
            const issue = context.payload.issue;
            const closedBy = context.payload.sender.login;
            
            // Only allow nisalgunawardhana to close and assign badges
            if (closedBy !== 'nisalgunawardhana') {
              console.log(`Issue closed by ${closedBy}, but only nisalgunawardhana can assign badges.`);
              
              // Add a comment explaining this
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `âš ï¸ **Note:** This issue was closed by @${closedBy}, but digital badges can only be issued by @nisalgunawardhana.
                
                If this submission should be approved, please wait for @nisalgunawardhana to review and close the issue.`
              });
              
              return; // Exit without assigning badge
            }
            
            // Extract user information from issue body
            const body = issue.body;
            let userName = 'Contributor';
            let userEmail = '';
            
            // Try to extract name and email from the issue body
            const nameMatch = body.match(/Full Name[:\s]+([^\n]+)/i);
            const emailMatch = body.match(/Email Address[:\s]+([^\n]+)/i);
            
            if (nameMatch) userName = nameMatch[1].trim();
            if (emailMatch) userEmail = emailMatch[1].trim();
            
            // Use custom badge image from repository
            const badgeUrl = `https://raw.githubusercontent.com/${context.repo.owner}/${context.repo.repo}/main/images/badge.png`;
            const completionDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            
            // Add congratulations comment with badge
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `## ğŸŠ Congratulations ${userName}! ğŸŠ
              
              Your submission has been **approved** by @nisalgunawardhana! You've successfully completed the MCP Server tutorial.
              
              ### ğŸ–ï¸ Your Digital Badge
              
              ![MCP Server Completion Badge](${badgeUrl})
              
              **Badge Details:**
              - **Name:** ${userName}
              - **Achievement:** MCP Server - .NET Implementation
              - **Completion Date:** ${completionDate}
              - **Repository:** ${context.repo.owner}/${context.repo.repo}
              - **Approved by:** @nisalgunawardhana
              
              ### How to Display Your Badge
              
              You can add this badge to your GitHub profile or project README:
              
              **Markdown:**
              \`\`\`markdown
              ![MCP Server Completed](${badgeUrl})
              \`\`\`
              
              **HTML:**
              \`\`\`html
              <img src="${badgeUrl}" alt="MCP Server Completed" />
              \`\`\`
              
              ### Share Your Achievement! ğŸš€
              
              Feel free to share your accomplishment on social media:
              - Twitter/X: "I just completed the MCP Server tutorial! ğŸ‰ #MCPServer #DotNet #GitHub"
              - LinkedIn: Share your learning experience and tag the maintainers
              
              Thank you for your contribution and for being part of our community! Keep building amazing things! ğŸ’ª
              
              ---
              *If you have any questions or feedback, feel free to reach out.*`
            });
            
            // Add labels: approved, completed
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['approved', 'completed']
            });
            
            // Remove pending review label
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                name: 'pending review'
              });
              console.log('Removed pending review label');
            } catch (error) {
              console.log('pending review label may not exist:', error.message);
            }
            
            console.log('Badge issued and labels updated successfully by nisalgunawardhana');
